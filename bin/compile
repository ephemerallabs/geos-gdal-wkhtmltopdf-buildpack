#!/usr/bin/env bash

set -e

BUILD_DIR=$1
TMP_DIR=$BUILD_DIR/tmp
VENDOR_DIR=$BUILD_DIR/vendor

CACHED_DIRS=".heroku"

mkdir -p $TMP_DIR
mkdir -p $VENDOR_DIR

GDAL_VERSION="1.11.1"
GEOS_VERSION="3.4.2"
WKHTMLTOPDF_VERSION="0.9.9"

cd $TMP_DIR

# Install GEOS
echo "Fetching and installing GEOS ($GEOS_VERSION)"
curl -O -s https://wapu-lib.s3.amazonaws.com/geos-$GEOS_VERSION-heroku.tar.gz
echo "Installing ..."
tar xzvf geos-$GEOS_VERSION-heroku.tar.gz
mv geos $VENDOR_DIR/geos-$GEOS_VERSION
echo "Cleaning up ..."
rm geos-$GEOS_VERSION-heroku.tar.gz
echo "GEOS installed"


# Install GDAL
echo "Fetching and installing GDAL ($GDAL_VERSION)"
curl -O https://wapu-lib.s3.amazonaws.com/gdal-$GDAL_VERSION-heroku.tar.gz
echo "Installing ..."
tar xzvf gdal-$GDAL_VERSION-heroku.tar.gz
mv gdal $VENDOR_DIR/gdal-$GDAL_VERSION
echo "Cleaning up ..."
rm gdal-$GDAL_VERSION-heroku.tar.gz
echo "GDAL installed"

# Install wkhtmltopdf
echo "Fetching and installing wkhtmltopdf ($WKHTMLTOPDF_VERSION)"
curl -O https://wapu-lib.s3.amazonaws.com/wkhtmltopdf-$WKHTMLTOPDF_VERSION-static-amd64.tar.gz
echo "Installing ..."
tar xzvf wkhtmltopdf-$WKHTMLTOPDF_VERSION-static-amd64.tar.gz
mkdir -p $VENDOR_DIR/wkhtmltopdf-$WKHTMLTOPDF_VERSION/bin
mv wkhtmltopdf-amd64 $VENDOR_DIR/wkhtmltopdf-$WKHTMLTOPDF_VERSION/bin/wkhtmltopdf
echo "Cleaning up ..."
rm wkhtmltopdf-$WKHTMLTOPDF_VERSION-static-amd64.tar.gz
echo "Wkhtmltopdf installed"

exit 0
