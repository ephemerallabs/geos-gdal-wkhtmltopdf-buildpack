#!/usr/bin/env bash

set -e

BUILD_DIR=$1
TMP_DIR="$BUILD_DIR/tmp"
APP_DIR="/app"
VENDOR_DIR="$app_DIR/vendor"

CACHED_DIRS=".heroku"

mkdir -p $TMP_DIR
mkdir -p $VENDOR_DIR

GDAL_VERSION="1.11.1"
GEOS_VERSION="3.4.2"
WKHTMLTOPDF_VERSION="0.9.9"


# Install GEOS
cd $TMP_DIR
echo "Fetching and installing GEOS ($GEOS_VERSION)"
curl -O -s https://wapu-lib.s3.amazonaws.com/geos-$GEOS_VERSION-heroku.tar.gz
echo "Installing ..."
tar xzf geos-$GEOS_VERSION-heroku.tar.gz
mv geos $VENDOR_DIR/geos-$GEOS_VERSION
echo "Cleaning up ..."
rm geos-$GEOS_VERSION-heroku.tar.gz
echo "GEOS installed"


# Install GDAL
cd $TMP_DIR
echo "Fetching and installing GDAL ($GDAL_VERSION)"
curl -O -s https://wapu-lib.s3.amazonaws.com/gdal-$GDAL_VERSION-heroku.tar.gz
echo "Installing ..."
tar xzf gdal-$GDAL_VERSION-heroku.tar.gz
mv gdal $VENDOR_DIR/gdal-$GDAL_VERSION
echo "Cleaning up ..."
rm gdal-$GDAL_VERSION-heroku.tar.gz
echo "GDAL installed"

# Install wkhtmltopdf
cd $TMP_DIR
echo "Fetching and installing wkhtmltopdf ($WKHTMLTOPDF_VERSION)"
curl -O -s https://wapu-lib.s3.amazonaws.com/wkhtmltopdf-$WKHTMLTOPDF_VERSION-static-amd64.tar.gz
echo "Installing ..."
tar xzf wkhtmltopdf-$WKHTMLTOPDF_VERSION-static-amd64.tar.gz
mkdir -p $VENDOR_DIR/wkhtmltopdf-$WKHTMLTOPDF_VERSION/bin
mv wkhtmltopdf-amd64 $VENDOR_DIR/wkhtmltopdf-$WKHTMLTOPDF_VERSION/bin/wkhtmltopdf
echo "Cleaning up ..."
rm wkhtmltopdf-$WKHTMLTOPDF_VERSION-static-amd64.tar.gz
echo "Wkhtmltopdf installed"

echo "-----------> Configuring environment"

export PATH="$PATH:$VENDOR_DIR/gdal-$GDAL_VERSION/bin:$VENDOR_DIR/geos-$GEOS_VERSION/bin:$VENDOR_DIR/wkhtmltopdf-$WKHTMLTOPDF_VERSION/bin"
export CPPPATH="$VENDOR_DIR/gdal-$GDAL_VERSION/include:$VENDOR_DIR/geos-$GEOS_VERSION/include:$CPPPATH"
export CPATH="$VENDOR_DIR/gdal-$GDAL_VERSION/include:$VENDOR_DIR/geos-$GEOS_VERSION/include:$CPATH"
export LIBRARY_PATH="$VENDOR_DIR/gdal-$GDAL_VERSION/lib:$VENDOR_DIR/geos-$GEOS_VERSION/lib:$LIBRARY_PATH"
export LD_LIBRARY_PATH="$VENDOR_DIR/gdal-$GDAL_VERSION/lib:$VENDOR_DIR/geos-$GEOS_VERSION/lib:$LD_LIBRARY_PATH"
export GDAL_DATA="$VENDOR_DIR/gdal-$GDAL_VERSION/share/gdal"

echo $PATH

exit 0
